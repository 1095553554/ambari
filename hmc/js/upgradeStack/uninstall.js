/*
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */

(function() {

  // initiates uninstall of stack and shows progress widget
  function uninstallStack() {
    $.ajax({
      type: 'POST',
      url: '/hmc/php/frontend/uninstall.php?clusterName=' + App.props.clusterName +
        '&action=uninstall&clusterDeployUser=root',
      data: {},
      timeout: App.io.DEFAULT_AJAX_TIMEOUT_MS,
      success: function (data) {
        showProgressWidget(data.response);
      },
      error: function () {
        alert(App.io.DEFAULT_AJAX_ERROR_MESSAGE);
      }
    });
  }

  function showProgressWidget(context) {
    var successMessage = null;
    var failureMessage = null;

    var onSuccess = function (widget) {
      widget.setTargetUrl('reconfigure.php');
    };

    var onFailure = function (widget) {
    };

    var onClose = function (widget) {
      // show loading screen while redirect happens upon widget closing
      App.ui.showLoadingOverlay();
    };

    var config = {
      context: context,
      title: 'Uninstall Progress',
      successMessage: successMessage,
      failureMessage: failureMessage,
      onSuccess: onSuccess,
      onFailure: onFailure,
      onClose: onClose
    };

    // hihack XHR for testing
    var initialResponse = '{"clusterName":"test","txnId":"4","progress":{"processRunning":true,"txnId":"4","subTxns":null,"encounteredError":false},"deployUser":"root"}';
    var inProgressResponse = '{"clusterName":"test","txnId":"4","progress":{"processRunning":true,"txnId":"4","subTxns":[{"subTxnId":"6","parentSubTxnId":"5","state":"STOPPED","description":"Nagios Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"5","parentSubTxnId":"3","state":"STOPPED","description":"Nagios stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"8","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Slave stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":6,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal","domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"9","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Collector stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"7","parentSubTxnId":"3","state":"STOPPED","description":"Ganglia stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"11","parentSubTxnId":"10","state":"STOPPED","description":"Monitoring Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"10","parentSubTxnId":"3","state":"STOPPED","description":"Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"14","parentSubTxnId":"12","state":"STOPPED","description":"Templeton Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"12","parentSubTxnId":"3","state":"STOPPED","description":"Templeton stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"18","parentSubTxnId":"15","state":"STOPPED","description":"MySql Server for Hive stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"19","parentSubTxnId":"15","state":"STOPPED","description":"Hive Metastore stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"15","parentSubTxnId":"3","state":"STOPPED","description":"Hive\/HCatalog stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"22","parentSubTxnId":"20","state":"STOPPED","description":"Oozie Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"20","parentSubTxnId":"3","state":"STOPPED","description":"Oozie stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"28","parentSubTxnId":"26","state":"STOPPED","description":"HBase Master stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"29","parentSubTxnId":"26","state":"STOPPED","description":"HBase Region Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"26","parentSubTxnId":"3","state":"STOPPED","description":"HBase stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"34","parentSubTxnId":"30","state":"STOPPED","description":"ZooKeeper Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"30","parentSubTxnId":"3","state":"STOPPED","description":"ZooKeeper stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"44","parentSubTxnId":"43","state":"STOPPED","description":"TaskTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"43","parentSubTxnId":"35","state":"STOPPED","description":"JobTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"35","parentSubTxnId":"3","state":"STOPPED","description":"MapReduce stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"57","parentSubTxnId":"47","state":"STOPPED","description":"Datanode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"61","parentSubTxnId":"59","state":"STOPPED","description":"Secondary NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"59","parentSubTxnId":"47","state":"STOPPED","description":"NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"47","parentSubTxnId":"3","state":"STOPPED","description":"HDFS stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"63","parentSubTxnId":"2","state":"UNINSTALLING","description":" Cluster uninstall","progress":"IN_PROGRESS","subTxnType":"CLUSTER","opStatus":[]}],"encounteredError":false},"deployUser":"root"}';
    var successResponse = '{"clusterName":"test","txnId":"4","progress":{"processRunning":false,"txnId":"4","subTxns":[{"subTxnId":"6","parentSubTxnId":"5","state":"STOPPED","description":"Nagios Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"5","parentSubTxnId":"3","state":"STOPPED","description":"Nagios stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"8","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Slave stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":6,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal","domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"9","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Collector stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"7","parentSubTxnId":"3","state":"STOPPED","description":"Ganglia stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"11","parentSubTxnId":"10","state":"STOPPED","description":"Monitoring Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"10","parentSubTxnId":"3","state":"STOPPED","description":"Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"14","parentSubTxnId":"12","state":"STOPPED","description":"Templeton Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"12","parentSubTxnId":"3","state":"STOPPED","description":"Templeton stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"18","parentSubTxnId":"15","state":"STOPPED","description":"MySql Server for Hive stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"19","parentSubTxnId":"15","state":"STOPPED","description":"Hive Metastore stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"15","parentSubTxnId":"3","state":"STOPPED","description":"Hive\/HCatalog stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"22","parentSubTxnId":"20","state":"STOPPED","description":"Oozie Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"20","parentSubTxnId":"3","state":"STOPPED","description":"Oozie stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"28","parentSubTxnId":"26","state":"STOPPED","description":"HBase Master stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"29","parentSubTxnId":"26","state":"STOPPED","description":"HBase Region Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"26","parentSubTxnId":"3","state":"STOPPED","description":"HBase stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"34","parentSubTxnId":"30","state":"STOPPED","description":"ZooKeeper Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"30","parentSubTxnId":"3","state":"STOPPED","description":"ZooKeeper stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"44","parentSubTxnId":"43","state":"STOPPED","description":"TaskTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"43","parentSubTxnId":"35","state":"STOPPED","description":"JobTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"35","parentSubTxnId":"3","state":"STOPPED","description":"MapReduce stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"57","parentSubTxnId":"47","state":"STOPPED","description":"Datanode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"61","parentSubTxnId":"59","state":"STOPPED","description":"Secondary NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"59","parentSubTxnId":"47","state":"STOPPED","description":"NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"47","parentSubTxnId":"3","state":"STOPPED","description":"HDFS stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"63","parentSubTxnId":"2","state":"UNINSTALLED","description":" Cluster uninstall","progress":"COMPLETED","subTxnType":"CLUSTER","opStatus":{"stats":{"NODE_COUNT":6,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-2-205-242.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-110-253-227.ec2.internal","ip-10-204-57-227.ec2.internal"]}}}],"encounteredError":false},"deployUser":"root"}';
    var errorResponse = '{"clusterName":"test","txnId":"4","progress":{"processRunning":false,"txnId":"4","subTxns":[{"subTxnId":"6","parentSubTxnId":"5","state":"STOPPED","description":"Nagios Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"5","parentSubTxnId":"3","state":"STOPPED","description":"Nagios stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"8","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Slave stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":6,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal","domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"9","parentSubTxnId":"7","state":"STOPPED","description":"Ganglia Collector stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"7","parentSubTxnId":"3","state":"STOPPED","description":"Ganglia stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"11","parentSubTxnId":"10","state":"STOPPED","description":"Monitoring Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"10","parentSubTxnId":"3","state":"STOPPED","description":"Dashboard stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"14","parentSubTxnId":"12","state":"STOPPED","description":"Templeton Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"12","parentSubTxnId":"3","state":"STOPPED","description":"Templeton stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"18","parentSubTxnId":"15","state":"STOPPED","description":"MySql Server for Hive stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"19","parentSubTxnId":"15","state":"STOPPED","description":"Hive Metastore stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"15","parentSubTxnId":"3","state":"STOPPED","description":"Hive\/HCatalog stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"22","parentSubTxnId":"20","state":"STOPPED","description":"Oozie Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"20","parentSubTxnId":"3","state":"STOPPED","description":"Oozie stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"28","parentSubTxnId":"26","state":"STOPPED","description":"HBase Master stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"29","parentSubTxnId":"26","state":"STOPPED","description":"HBase Region Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"26","parentSubTxnId":"3","state":"STOPPED","description":"HBase stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"34","parentSubTxnId":"30","state":"STOPPED","description":"ZooKeeper Server stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-110-253-227.ec2.internal","ip-10-2-205-242.ec2.internal"]}}},{"subTxnId":"30","parentSubTxnId":"3","state":"STOPPED","description":"ZooKeeper stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"44","parentSubTxnId":"43","state":"STOPPED","description":"TaskTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"43","parentSubTxnId":"35","state":"STOPPED","description":"JobTracker stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"35","parentSubTxnId":"3","state":"STOPPED","description":"MapReduce stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"57","parentSubTxnId":"47","state":"STOPPED","description":"Datanode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":3,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-204-57-227.ec2.internal"]}}},{"subTxnId":"61","parentSubTxnId":"59","state":"STOPPED","description":"Secondary NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-110-253-227.ec2.internal"]}}},{"subTxnId":"59","parentSubTxnId":"47","state":"STOPPED","description":"NameNode stop","progress":"COMPLETED","subTxnType":"SERVICECOMPONENT","opStatus":{"stats":{"NODE_COUNT":1,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["domu-12-31-39-10-3d-e2.compute-1.internal"]}}},{"subTxnId":"47","parentSubTxnId":"3","state":"STOPPED","description":"HDFS stop","progress":"COMPLETED","subTxnType":"SERVICE","opStatus":[]},{"subTxnId":"63","parentSubTxnId":"2","state":"UNINSTALLED","description":" Cluster uninstall","progress":"FAILED","subTxnType":"CLUSTER","opStatus":{"stats":{"NODE_COUNT":6,"TIME_TAKEN_SECS":0},"nodeReport":{"PUPPET_KICK_FAILED":[],"PUPPET_OPERATION_FAILED":[],"PUPPET_OPERATION_TIMEDOUT":[],"PUPPET_OPERATION_SUCCEEDED":["ip-10-72-242-81.ec2.internal","domu-12-31-39-10-3d-e2.compute-1.internal","ip-10-2-205-242.ec2.internal","ip-10-73-14-12.ec2.internal","ip-10-110-253-227.ec2.internal","ip-10-204-57-227.ec2.internal"]}}}],"encounteredError":true},"deployUser":"root"}';
    var server = sinon.fakeServer.create();

    var numCalled = 0;

    server.respondWith(
      function (request) {
        var body;
        numCalled++;
        if (numCalled == 1) {
          body = initialResponse;
        } else if (numCalled == 2) {
          body = inProgressResponse;
        } else if (numCalled == 3) {
          body = successResponse;
          //body = errorResponse;
          server.restore();
        }
        request.respond('200', { 'Content-Type': 'application/json' }, body);
      }
    );

    server.autoRespond = true;

    new App.ui.TxnProgressWidget(config).show();

  }

  $('#uninstallSubmitButton').click(function() {
    uninstallStack();
  });

  App.ui.hideLoadingOverlay();

})();


